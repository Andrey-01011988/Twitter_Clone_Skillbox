```commandline
Что такое middleware? Как он используется в FastAPI? Объясни подробно и с примерами.
```
---
### Что такое Middleware?

**Middleware** (промежуточное ПО) — это функции, которые обрабатывают запросы и ответы в веб-приложениях. Они выполняются до того, как запрос достигнет конечной точки (endpoint), и после того, как ответ будет сгенерирован. Middleware позволяет добавлять дополнительную функциональность к вашему приложению, такую как логирование, аутентификация, обработка ошибок и модификация запросов или ответов.

### Как Middleware используется в FastAPI?

В FastAPI middleware регистрируется с помощью декоратора `@app.middleware("http")`. Это позволяет вам определить функции, которые будут выполняться для каждого HTTP-запроса.

#### Основные шаги работы Middleware в FastAPI:

1. **Получение запроса**: Middleware получает объект запроса.
2. **Обработка запроса**: Middleware может изменять запрос или выполнять дополнительные действия (например, логирование).
3. **Передача управления**: Middleware передает управление следующему обработчику с помощью функции `call_next`.
4. **Получение ответа**: После обработки запроса, middleware получает ответ от обработчика.
5. **Обработка ответа**: Middleware может изменять ответ перед его отправкой клиенту.

### Пример использования Middleware

Рассмотрим пример middleware, которое логирует время обработки каждого запроса:

```python
import time
from fastapi import FastAPI, Request

app = FastAPI()

@app.middleware("http")
async def log_requests(request: Request, call_next):
    start_time = time.time()  # Засекаем время начала обработки запроса
    response = await call_next(request)  # Передаем запрос следующему обработчику
    duration = time.time() - start_time  # Вычисляем время обработки
    # Логируем метод запроса и время обработки
    print(f"Request: {request.method} {request.url} - Duration: {duration:.3f} seconds")
    return response  # Возвращаем ответ
```

#### Объяснение кода:

- **`@app.middleware("http")`**: Декоратор указывает FastAPI, что функция `log_requests` будет использоваться как middleware для всех HTTP-запросов.
- **`async def log_requests(request: Request, call_next)`**: Определяет асинхронную функцию middleware. Она принимает объект запроса и функцию `call_next`, которая передает запрос следующему обработчику.
- **`start_time = time.time()`**: Засекает текущее время перед обработкой запроса.
- **`response = await call_next(request)`**: Передает управление следующему обработчику и ждет его ответа.
- **`duration = time.time() - start_time`**: Вычисляет время обработки запроса.
- **`print(...)`**: Логирует метод и URL запроса вместе с временем обработки.
- **`return response`**: Возвращает ответ клиенту.

### Другие примеры использования Middleware

1. **Аутентификация**:
   Middleware может проверять заголовки авторизации и блокировать доступ к определенным маршрутам для неавторизованных пользователей.

2. **Обработка ошибок**:
   Middleware может перехватывать ошибки и возвращать пользовательские сообщения об ошибках вместо стандартных ответов.

3. **Изменение заголовков ответа**:
   Вы можете добавлять или изменять заголовки в ответах, например, для настройки CORS или добавления метрик.

### Заключение

Middleware в FastAPI — это мощный инструмент для расширения функциональности вашего приложения. Он позволяет управлять процессом обработки запросов и ответов, добавляя общие операции без изменения кода конкретных маршрутов. С помощью middleware вы можете улучшить структуру вашего приложения и сделать его более гибким и масштабируемым.

Citations:
[1] https://codelab.pro/kurs-po-fastapi-middleware-i-fonovaya-obrabotka-zadach-7/
[2] https://ramziv.com/article/47
[3] https://semaphoreci.com/blog/custom-middleware-fastapi
[4] https://fastapi.tiangolo.com/tutorial/middleware/