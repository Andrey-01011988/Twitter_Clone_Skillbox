## Команды Alembic

Alembic — это инструмент для миграции баз данных, который используется в сочетании с SQLAlchemy. Он позволяет управлять изменениями в структуре базы данных через систему версий, что упрощает процесс обновления и отката изменений.

**** Основные команды Alembic

Вот основные команды, которые вы можете использовать с Alembic:

- **Инициализация проекта**:
  ```bash
  alembic init <foldername>
  ```
  Эта команда создает структуру каталогов и файл конфигурации `alembic.ini`.

- **Создание миграции**:
  ```bash
  alembic revision -m "Описание миграции" --autogenerate
  ```
  Эта команда генерирует новый файл миграции на основе изменений в моделях.

- **Применение миграций**:
  ```bash
  alembic upgrade head
  ```
  Эта команда применяет все доступные миграции до самой последней версии.

- **Откат миграций**:
  ```bash
  alembic downgrade <revision>
  ```
  Эта команда откатывает базу данных до указанной ревизии.

- **Просмотр текущей версии**:
  ```bash
  alembic current
  ```
  Показывает текущую версию миграций в базе данных.

- **История миграций**:
  ```bash
  alembic history --verbose
  ```
  Отображает список всех выполненных миграций с подробной информацией.

- **Справка по командам**:
  ```bash
  alembic --help
  ```
  Показывает доступные команды и их описание.

**** Примеры использования

1. **Инициализация Alembic**:
   После установки Alembic, выполните команду инициализации для создания структуры проекта:

   ```bash
   alembic init migrations
   ```

2. **Создание начальной миграции**:
   Если у вас уже есть база данных, вы можете создать начальную миграцию с помощью команды:

   ```bash
   alembic revision --autogenerate -m "initial migration"
   ```

3. **Применение миграций**:
   Чтобы применить все изменения к базе данных, используйте:

   ```bash
   alembic upgrade head
   ```

4. **Откат изменений**:
   Если необходимо откатить последние изменения, выполните:

   ```bash
   alembic downgrade -1
   ```

5. **Стадия без применения изменений**:
   Если нужно просто зафиксировать текущее состояние базы данных без применения изменений, используйте команду `stamp`:

   ```bash
   alembic stamp <revision>
   ```

Эти команды позволяют эффективно управлять структурой базы данных и обеспечивают контроль версий для ваших схем. Alembic значительно упрощает процесс разработки и развертывания приложений, использующих SQLAlchemy для работы с базами данных.

Команда `alembic merge heads -m "merge add users patronomic"` выполняет слияние нескольких "голов" (heads) миграций в Alembic. Вот что это означает и как работает:

### Что делает команда

1. **Слияние голов**: Alembic позволяет иметь несколько "голов" миграций, что может происходить, когда разные разработчики создают миграции на основе одной и той же предыдущей версии. Команда `merge heads` создает новую миграцию, которая объединяет все текущие головы в одну.

2. **Создание точки слияния**: При выполнении этой команды создается новый файл миграции, который будет иметь несколько родительских версий (все текущие головы). Это позволяет Alembic отслеживать изменения и поддерживать целостность схемы базы данных.

3. **Упрощение управления миграциями**: Слияние голов помогает избежать конфликтов и упрощает процесс обновления базы данных, особенно в проектах с несколькими разработчиками, где могут возникать параллельные изменения в схеме.

### Пример использования

Предположим, у вас есть две миграции, которые были созданы независимо друг от друга:

- **Миграция A** добавляет столбец `surname`.
- **Миграция B** добавляет столбец `patronomic`.

После того как обе миграции были созданы, они становятся головами. Выполнение команды `alembic merge heads -m "merge add users patronomic"` создаст новую миграцию (например, `merge_add_users_patronomic.py`), которая будет объединять обе эти головы.

### Ожидаемый результат

После выполнения команды:

- Ваша история миграций будет обновлена, и новая точка слияния станет последней версией.
- Теперь вы сможете использовать команду `alembic upgrade head`, чтобы обновить базу данных до новой версии без конфликтов.

### Заключение

Команда `alembic merge heads` является важным инструментом для управления миграциями в проектах с несколькими разработчиками, позволяя эффективно объединять изменения и поддерживать согласованность схемы базы данных.

Citations:
[1] https://alembic.sqlalchemy.org/en/latest/branches.html
[2] https://github.com/sqlalchemy/alembic/issues/167
[3] https://blog.jerrycodes.com/multiple-heads-in-alembic-migrations/
[4] https://testdriven.io/blog/alembic-database-migrations/
[5] https://stackoverflow.com/questions/22342643/alembic-revision-multiple-heads-due-branching-error/
[6] https://alembic.sqlalchemy.org/en/latest/api/commands.html
[7] https://alembic.sqlalchemy.org/en/latest/tutorial.html
[8] https://alembic.sqlalchemy.org/en/latest/cookbook.html

Citations:
[1] https://blog.volodichev.com/alembic
[2] https://habr.com/ru/articles/585228/
[3] https://konstantinklepikov.github.io/myknowlegebase/notes/alembic.html
[4] https://ploshadka.net/komandy-dlja-alembic/
[5] https://alembic.sqlalchemy.org/en/latest/api/commands.html
